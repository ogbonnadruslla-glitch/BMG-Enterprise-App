import { GoogleGenAI, Chat, GenerateContentResponse, Type } from "@google/genai";
import { SalesLog, SalesTarget } from '../types';

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });

let chatInstance: Chat | null = null;
let supportChatInstance: Chat | null = null;

const getChatInstance = () => {
  if (!chatInstance) {
    chatInstance = ai.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: 'You are "GrowthBot", an expert business advisor for BMG (Business Must Grow) Solutions. Your tone is professional, encouraging, and highly insightful. Provide actionable advice to help businesses scale. When asked about BMG, explain it is a solution-oriented company dedicated to fostering business growth through technology and expert insights.',
      },
    });
  }
  return chatInstance;
};

const getSupportChatInstance = () => {
    if (!supportChatInstance) {
        supportChatInstance = ai.chats.create({
            model: 'gemini-2.5-flash',
            config: {
                systemInstruction: "You are a friendly and helpful first-line support agent for BMG (Business Must Grow) Enterprise Solutions. Your goal is to answer user questions based on general business knowledge and information about the BMG app's features (Dashboard, Sales Planning, AI Advisor, Reports, Templates, etc.). If a question is too complex, requires personal user data you don't have, or is a complaint, you must politely inform the user that a human support agent will review their request and get back to them shortly. Do not invent information you don't have.",
            },
        });
    }
    return supportChatInstance;
};


export const generateBusinessAdviceStream = async (
  prompt: string,
): Promise<AsyncGenerator<GenerateContentResponse>> => {
  const chat = getChatInstance();
  return chat.sendMessageStream({ message: prompt });
};

export const generateSupportResponseStream = async (
    prompt: string,
): Promise<AsyncGenerator<GenerateContentResponse>> => {
    const chat = getSupportChatInstance();
    return chat.sendMessageStream({ message: prompt });
};

export const generateAiSalesPlan = async (goal: string): Promise<string> => {
    try {
        const prompt = `
            You are an expert business growth strategist for 'BMG (Business Must Grow) Enterprise Solutions'.
            A user needs an actionable sales plan to achieve a specific goal.
            Their goal is: "${goal}".

            Generate a comprehensive, actionable sales plan in Markdown format. The plan should be structured and easy to follow. Include these sections:
            1.  **Objective Clarity:** Briefly restate the goal to confirm understanding.
            2.  **Target Audience Identification:** Suggest the key customer segments to focus on.
            3.  **Key Strategies & Tactics:** Propose 3-5 high-impact strategies (e.g., specific marketing channels, sales techniques, partnership ideas). For each strategy, list concrete action steps.
            4.  **KPIs for Success:** Define 3-4 Key Performance Indicators to track progress towards the goal (e.g., Number of leads per week, Conversion rate, Customer Acquisition Cost).
            5.  **Potential Risks & Mitigations:** Identify 2-3 potential challenges and suggest ways to overcome them.
            
            Keep the tone professional, encouraging, and highly practical.
        `;
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-pro',
            contents: prompt,
        });
        return response.text;
    } catch (error) {
        console.error("Error generating AI sales plan:", error);
        return "Sorry, I couldn't generate a sales plan at the moment. Please try again later.";
    }
};

export const generateSalesPlan = async (prompt: string): Promise<string> => {
    try {
        const response = await ai.models.generateContent({
          model: 'gemini-2.5-pro',
          contents: `Based on the following business description, create a structured sales plan. The user needs targets for daily, weekly, monthly, quarterly, and annually. The output must be a JSON object with a 'targets' array. Each object in the array should have 'period' and 'target' keys.
          Business description: "${prompt}"`,
           config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        targets: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    period: { type: Type.STRING },
                                    target: { type: Type.NUMBER }
                                }
                            }
                        }
                    }
                }
           }
        });
        return response.text;
    } catch (error) {
        console.error("Error generating sales plan:", error);
        return JSON.stringify({ error: "Sorry, I couldn't generate a sales plan at the moment. Please try again later." });
    }
};

export const startReviewCheckin = async (targets: SalesTarget, logs: SalesLog[]): Promise<string> => {
    try {
        const lastLog = logs.length > 0 ? logs[0] : null; // Logs are prepended, so the most recent is at index 0
        const prompt = `
            You are a supportive but firm business coach for 'BMG (Business Must Grow) Enterprise Solutions'. You are conducting a weekly check-in meeting with a business owner.
            Here is their sales data:
            - Targets: ${JSON.stringify(targets)}
            - Recent Sales Logs (last 10): ${JSON.stringify(logs.slice(0, 10))}
            Your task is to start an interactive review meeting. Analyze the data provided.
            Begin the conversation by greeting them and asking an open-ended question about their performance and feelings about the past week, referencing a specific piece of their data (e.g., "I see you logged a sale for '${lastLog ? lastLog.notes : '...'}' on ${lastLog ? lastLog.date : '...'}, how did that feel?" or "It looks like you're making progress toward your weekly target. Let's talk about what went well.").
            Wait for their response. Do not script the entire conversation, just provide the opening line. Your opening MUST be engaging and encouraging.
        `;
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-pro',
            contents: prompt,
        });
        return response.text;
    } catch (error) {
        console.error("Error starting review check-in:", error);
        return "Sorry, I couldn't start the review session. Please check your data and try again.";
    }
};

export const generateReportAnalysis = async (filteredLogs: SalesLog[], dateRange: { start: string, end: string }): Promise<string> => {
    try {
        const prompt = `
            You are a senior business analyst for 'BMG (Business Must Grow) Enterprise Solutions'.
            You have been provided with a business owner's sales data for the period from ${dateRange.start} to ${dateRange.end}.
            The data is: ${JSON.stringify(filteredLogs.slice(0, 100))} (showing up to 100 logs).
            Your task is to generate a concise, insightful report in Markdown format. The report should contain three sections:
            1.  **Performance Overview:** Give a brief, high-level summary of the sales performance during this period. Mention total revenue and number of sales.
            2.  **Key Trends & Observations:** Analyze the data to identify any patterns. For example, were there specific days with higher sales? Did certain products or categories perform better than others?
            3.  **Actionable Insights & Recommendations:** Based on your analysis, provide 2-3 concrete, actionable recommendations that the business owner can implement to improve their sales.
            Keep the tone professional, encouraging, and easy to understand.
        `;
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-pro',
            contents: prompt,
        });
        return response.text;
    } catch (error) {
        console.error("Error generating report analysis:", error);
        return "Sorry, I couldn't generate an analysis at this moment. Please try again later.";
    }
};